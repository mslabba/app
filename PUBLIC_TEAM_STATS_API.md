# Public Team Statistics API Endpoints

## Overview
These endpoints support the public team statistics page, allowing team owners to view real-time auction data via secure, shareable links.

## Security Model
- **No authentication required** for public endpoints
- **Secure tokens** prevent unauthorized access
- **Team-specific tokens** generated by admin
- **Token expiration** for security (optional)

## API Endpoints

### 1. Generate Public Team Link
```
POST /api/teams/{team_id}/generate-public-link
Authorization: Bearer {admin_token}
```

**Request Body:**
```json
{
  "expires_in_days": 30  // Optional, default 30 days
}
```

**Response:**
```json
{
  "success": true,
  "public_url": "https://your-app.com/public/team/123/stats?token=abc123def456",
  "token": "abc123def456",
  "expires_at": "2024-12-01T00:00:00Z"
}
```

### 2. Get Team Statistics (Public)
```
GET /api/public/team/{team_id}/stats?token={secure_token}
```

**Response:**
```json
{
  "team": {
    "id": 1,
    "name": "Mumbai Warriors",
    "logo_url": "https://...",
    "color": "#FF6B6B",
    "budget": 1000000,
    "remaining": 750000,
    "spent": 250000,
    "max_squad_size": 15
  },
  "event": {
    "id": 1,
    "name": "IPL 2024 Auction",
    "status": "active"
  },
  "categories": [
    {
      "id": 1,
      "name": "Batsmen",
      "color": "#4ECDC4",
      "min_players": 4,
      "max_players": 6
    }
  ]
}
```

### 3. Get Team Players (Public)
```
GET /api/public/team/{team_id}/players?token={secure_token}
```

**Response:**
```json
[
  {
    "id": 1,
    "name": "Virat Kohli",
    "position": "Batsman",
    "age": 35,
    "photo_url": "https://...",
    "base_price": 200000,
    "sold_price": 1700000,
    "category_id": 1,
    "bought_at": "2024-11-04T10:30:00Z"
  }
]
```

### 4. Get Auction State (Public)
```
GET /api/public/team/{team_id}/auction-state?token={secure_token}
```

**Response:**
```json
{
  "current_player": {
    "id": 45,
    "name": "MS Dhoni",
    "current_bid": 800000,
    "is_team_bidding": false
  },
  "auction_status": "active",
  "last_updated": "2024-11-04T10:30:00Z"
}
```

## Backend Implementation

### Python/Flask Implementation:

```python
import secrets
import hashlib
from datetime import datetime, timedelta
from flask import Blueprint, request, jsonify

public_bp = Blueprint('public', __name__, url_prefix='/api/public')

# Token management
def generate_secure_token(team_id, expires_days=30):
    """Generate secure token for public access"""
    random_string = secrets.token_urlsafe(32)
    expires_at = datetime.utcnow() + timedelta(days=expires_days)
    
    # Store in database
    token_data = {
        'token': random_string,
        'team_id': team_id,
        'expires_at': expires_at,
        'created_at': datetime.utcnow()
    }
    
    # Insert into public_tokens table
    db.execute("""
        INSERT INTO public_team_tokens (token, team_id, expires_at, created_at)
        VALUES (?, ?, ?, ?)
    """, (token_data['token'], team_id, expires_at, datetime.utcnow()))
    
    return token_data

def validate_token(token, team_id):
    """Validate public access token"""
    result = db.execute("""
        SELECT * FROM public_team_tokens 
        WHERE token = ? AND team_id = ? AND expires_at > ?
    """, (token, team_id, datetime.utcnow())).fetchone()
    
    return result is not None

# Public API endpoints
@public_bp.route('/team/<int:team_id>/stats')
def get_public_team_stats(team_id):
    token = request.args.get('token')
    
    if not token or not validate_token(token, team_id):
        return jsonify({'error': 'Invalid or expired token'}), 403
    
    # Get team data
    team = db.execute("""
        SELECT t.*, 
               COALESCE(t.budget - SUM(p.sold_price), t.budget) as remaining,
               COALESCE(SUM(p.sold_price), 0) as spent
        FROM teams t
        LEFT JOIN players p ON t.id = p.team_id AND p.sold_price > 0
        WHERE t.id = ?
        GROUP BY t.id
    """, (team_id,)).fetchone()
    
    if not team:
        return jsonify({'error': 'Team not found'}), 404
    
    # Get event and categories
    event = db.execute("SELECT * FROM events WHERE id = ?", (team['event_id'],)).fetchone()
    categories = db.execute("SELECT * FROM categories WHERE event_id = ?", (team['event_id'],)).fetchall()
    
    return jsonify({
        'team': dict(team),
        'event': dict(event) if event else None,
        'categories': [dict(cat) for cat in categories]
    })

@public_bp.route('/team/<int:team_id>/players')
def get_public_team_players(team_id):
    token = request.args.get('token')
    
    if not token or not validate_token(token, team_id):
        return jsonify({'error': 'Invalid or expired token'}), 403
    
    players = db.execute("""
        SELECT p.*, c.name as category_name, c.color as category_color
        FROM players p
        LEFT JOIN categories c ON p.category_id = c.id
        WHERE p.team_id = ? AND p.sold_price > 0
        ORDER BY p.sold_price DESC
    """, (team_id,)).fetchall()
    
    return jsonify([dict(player) for player in players])

@public_bp.route('/team/<int:team_id>/auction-state')
def get_public_auction_state(team_id):
    token = request.args.get('token')
    
    if not token or not validate_token(token, team_id):
        return jsonify({'error': 'Invalid or expired token'}), 403
    
    # Get current auction state (if any)
    current_auction = db.execute("""
        SELECT p.*, 
               CASE WHEN cb.team_id = ? THEN true ELSE false END as is_team_bidding
        FROM auction_state a
        JOIN players p ON a.current_player_id = p.id
        LEFT JOIN current_bids cb ON p.id = cb.player_id
        WHERE a.id = 1
    """, (team_id,)).fetchone()
    
    return jsonify({
        'current_player': dict(current_auction) if current_auction else None,
        'auction_status': 'active' if current_auction else 'inactive',
        'last_updated': datetime.utcnow().isoformat()
    })

# Admin endpoint to generate public links
@app.route('/api/teams/<int:team_id>/generate-public-link', methods=['POST'])
@admin_required
def generate_public_link(team_id):
    expires_days = request.json.get('expires_in_days', 30)
    token_data = generate_secure_token(team_id, expires_days)
    
    base_url = request.host_url.rstrip('/')
    public_url = f"{base_url}/public/team/{team_id}/stats?token={token_data['token']}"
    
    return jsonify({
        'success': True,
        'public_url': public_url,
        'token': token_data['token'],
        'expires_at': token_data['expires_at'].isoformat()
    })
```

## Database Schema Addition

```sql
-- Add table for public access tokens
CREATE TABLE public_team_tokens (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    token VARCHAR(64) UNIQUE NOT NULL,
    team_id INTEGER NOT NULL,
    expires_at DATETIME NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_accessed DATETIME,
    FOREIGN KEY (team_id) REFERENCES teams(id) ON DELETE CASCADE
);

-- Add index for performance
CREATE INDEX idx_public_tokens_team_token ON public_team_tokens(team_id, token);
CREATE INDEX idx_public_tokens_expires ON public_team_tokens(expires_at);
```

## Frontend Integration

### Add to App.js routing:

```javascript
// Add public route (no authentication required)
<Route 
  path="/public/team/:teamId/stats" 
  element={<PublicTeamStats />} 
/>
```

### Add to Admin Dashboard:

```javascript
const generatePublicLink = async (teamId) => {
  try {
    const response = await axios.post(`${API}/teams/${teamId}/generate-public-link`);
    const publicUrl = response.data.public_url;
    
    // Copy to clipboard
    navigator.clipboard.writeText(publicUrl);
    toast.success('Public link copied to clipboard!');
    
    // Show link in modal for sharing
    setPublicLinkModal({ show: true, url: publicUrl, teamId });
  } catch (error) {
    toast.error('Failed to generate public link');
  }
};
```

## Usage Workflow

1. **Admin generates link** for a team via admin dashboard
2. **Admin shares link** with team owner via email/WhatsApp
3. **Team owner accesses** real-time statistics without login
4. **Auto-refresh** keeps data current during auction
5. **Secure access** via token prevents unauthorized viewing

This implementation provides a complete public team statistics solution with real-time updates and secure access! ðŸŽ¯